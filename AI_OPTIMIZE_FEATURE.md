# AI 需求優化功能說明

## 功能概述

在文檔生成畫面新增了一個「AI 優化需求」功能，可以使用 AI API 對使用者輸入的需求描述進行智能優化，並且可以編輯後再整合產生文檔。

---

## 功能特點

✨ **智能優化**：根據選擇的文檔類型（系統文檔、SOP、技術報告），AI 會提供專業的需求優化建議

📝 **可編輯**：優化後的內容可以再次編輯，確保符合實際需求

🔄 **靈活操作**：可以使用優化結果、恢復原始需求、或取消操作

---

## 使用流程

### 步驟 1：輸入原始需求

1. 選擇文檔類型（系統文檔、SOP、技術報告）
2. 在「需求描述」欄位輸入您的需求
3. 點擊「✨ AI 優化需求」按鈕

### 步驟 2：查看優化結果

系統會呼叫 AI API 進行優化，並在下方顯示「AI 優化後的需求」區域。

優化內容包括：
- 補充必要的細節
- 使用專業術語
- 結構清晰分點
- 符合文檔類型特點

### 步驟 3：編輯優化結果

在「AI 優化後的需求」文字框中，您可以：
- 直接編輯優化後的內容
- 根據實際情況調整細節
- 添加或刪除部分內容

### 步驟 4：選擇操作

三個按鈕選項：

1. **✅ 使用優化後的需求**
   - 將優化後的內容應用到原始需求欄位
   - 用於正式生成文檔

2. **↩️ 恢復原始需求**
   - 將原始需求內容恢復到優化區域
   - 可重新編輯

3. **❌ 取消**
   - 關閉優化區域
   - 保持原始需求不變

### 步驟 5：生成文檔

確認需求內容後，繼續選擇模板和輸出格式，點擊「生成文檔」按鈕。

---

## 技術實作

### 後端 API（routes.py）

```python
@bp.route('/api/optimize-requirements', methods=['POST'])
def optimize_requirements():
    """使用 AI 優化需求描述"""
    # 1. 接收參數：requirements, doc_type
    # 2. 根據文檔類型構建優化提示詞
    # 3. 呼叫 AI API
    # 4. 返回優化結果
```

### 前端 UI（index_v3.html）

**新增元素：**
1. 「✨ AI 優化需求」按鈕
2. 「AI 優化後的需求」可編輯區域
3. 三個操作按鈕（使用/取消/恢復）

**JavaScript 邏輯：**
- `optimize-btn`：呼叫優化 API
- `use-optimized-btn`：應用優化結果
- `cancel-optimized-btn`：取消操作
- `revert-original-btn`：恢復原始需求

---

## 使用範例

### 範例 1：系統文檔

**原始需求：**
```
開發一個電商網站
```

**AI 優化後：**
```
## 電商網站系統需求

### 系統概述
開發一個全功能的電子商務網站系統，支援商品展示、購物車、訂單管理和支付功能。

### 功能需求
1. 商品管理
   - 商品分類瀏覽
   - 商品搜尋功能
   - 商品詳情展示

2. 購物功能
   - 購物車管理
   - 結帳流程
   - 訂單追蹤

3. 會員系統
   - 用戶註冊/登入
   - 個人資料管理
   - 訂單歷史查詢

### 技術需求
- 前端：React/Vue.js
- 後端：Python Flask/FastAPI
- 資料庫：PostgreSQL
- 支付：整合第三方支付 API
```

### 範例 2：SOP

**原始需求：**
```
客戶投訴處理流程
```

**AI 優化後：**
```
## 客戶投訴處理標準作業程序

### 目的
建立標準化的客戶投訴處理流程，確保問題及時有效解決，提升客戶滿意度。

### 適用範圍
- 所有客戶服務部門人員
- 產品相關投訴處理
- 服務品質相關投訴

### 作業程序
1. 接收投訴（5分鐘內）
   - 記錄投訴內容
   - 確認客戶聯絡方式
   - 分配處理人員

2. 問題分析（30分鐘內）
   - 了解問題原因
   - 評估嚴重程度
   - 制定解決方案

3. 執行處理（依問題複雜度）
   - 實施解決方案
   - 與客戶保持溝通
   - 記錄處理過程

4. 確認結案（24小時內）
   - 確認客戶滿意度
   - 歸檔處理記錄
   - 檢討改善機會

### 注意事項
- 保持專業態度
- 及時回應客戶
- 遵守承諾時限
```

---

## 優化策略

AI 會根據不同文檔類型採用不同的優化策略：

### 系統文檔
- 補充系統架構資訊（前端、後端、資料庫）
- 明確功能模組劃分
- 列出技術棧需求
- 包含部署和維護說明
- 使用專業術語，結構清晰

### SOP（標準作業程序）⭐ 專業格式
採用企業級 SOP 格式，每段 SOP 包含以下章節：

#### (A) 作業目的
- 明確說明此 SOP 的目標和意義

#### (B) 使用角色
- 列出涉及的角色（例如：採購人員、審核主管）

#### (C) 系統流程圖
- 文字描述系統流程（例如：申請 → 審核 → 執行）

#### (D) 作業流程步驟
- 逐步條列操作步驟
- 包含 UI 操作說明（點選按鈕、輸入欄位、儲存）

#### (E) 異常處理 / 錯誤訊息處理
- 列出可能的異常情況
- 提供處理方法

#### (F) 注意事項
- 重要提醒和最佳實踐

**特色**：
- 保持明確、實務，不誇大或補造功能
- 準確描述流程，不幻想不存在的系統功能
- 內容保持一致性

### 技術報告
- 補充背景資訊和問題陳述
- 列出技術方案和分析方法
- 包含數據分析和實施細節
- 提供結論和建議
- 使用專業術語，結構清晰

---

## 注意事項

### 1. API Key 配置
確保在「設定」頁面正確配置了 API Key（Gemini 或 OpenAI）。

### 2. 網路連線
優化功能需要網路連線來呼叫 AI API。

### 3. 處理時間
根據需求複雜度，AI 優化可能需要 5-15 秒。

### 4. 內容審查
AI 優化結果僅供參考，請根據實際情況進行調整和確認。

### 5. 成本考量
每次優化會消耗 AI API 額度，請合理使用。

---

## 錯誤處理

### 常見錯誤及解決方案

**錯誤 1：「請先輸入需求描述」**
- 原因：需求欄位為空
- 解決：輸入需求描述後再點擊優化按鈕

**錯誤 2：「請先選擇文檔類型」**
- 原因：未選擇文檔類型
- 解決：在下拉選單中選擇文檔類型

**錯誤 3：「未設置 API 密鑰」**
- 原因：未配置 AI API Key
- 解決：前往設定頁面配置 API Key

**錯誤 4：「API 調用失敗」**
- 原因：網路問題或 API 額度不足
- 解決：檢查網路連線或 API 額度

---

## 測試步驟

### 1. 啟動應用
```bash
python run.py
```

### 2. 開啟瀏覽器
```
http://localhost:5000
```

### 3. 測試流程
1. 選擇「系統文檔」
2. 輸入簡單需求：「開發一個待辦事項管理系統」
3. 點擊「✨ AI 優化需求」
4. 查看優化結果
5. 編輯優化內容
6. 點擊「✅ 使用優化後的需求」
7. 繼續選擇模板和格式
8. 生成文檔

---

## 更新日誌

### 2025-11-26 v2 (最新)
- ✅ **SOP 優化提示詞升級**：採用企業級 SOP 格式
  - 包含 6 大章節：作業目的、使用角色、系統流程圖、作業流程步驟、異常處理、注意事項
  - 強調實務性，不補造不存在的功能
  - 包含 UI 操作說明
- ✅ **系統文檔優化提示詞升級**：補充系統架構、技術棧需求
- ✅ **技術報告優化提示詞升級**：補充背景資訊、技術方案、結論建議
- ✅ **按鈕樣式優化**：AI 優化需求按鈕改為紫色漸變，更醒目
- ✅ **修復 Bug**：修復 `call_ai_api()` 方法不存在的錯誤

### 2025-11-26 v1
- ✅ 新增 `/api/optimize-requirements` API 端點
- ✅ 前端加入優化需求 UI 區域
- ✅ 實作 JavaScript 處理邏輯
- ✅ 支援三種文檔類型的優化策略
- ✅ 可編輯優化結果
- ✅ 靈活的操作選項（使用/取消/恢復）

---

## 未來改進

### 短期
- [ ] 加入優化歷史記錄
- [ ] 支援多次優化比較
- [ ] 提供優化品質評分

### 長期
- [ ] 支援自定義優化提示詞
- [ ] 整合更多 AI 模型選項
- [ ] 加入優化範本庫

---

## 技術架構

```
使用者輸入需求
    ↓
點擊「AI 優化需求」
    ↓
前端 JavaScript
    ↓
POST /api/optimize-requirements
    ↓
AIService.call_ai_api()
    ↓
Gemini/OpenAI API
    ↓
返回優化結果
    ↓
顯示在可編輯區域
    ↓
使用者編輯/確認
    ↓
整合到原始需求
    ↓
生成文檔
```

---

## 相關檔案

- **後端 API**：`app/routes.py` (第 130-180 行)
- **前端 UI**：`templates/index_v3.html` (第 731-770 行)
- **JavaScript**：`templates/index_v3.html` (第 1270-1360 行)
- **AI 服務**：`app/services/ai_service.py`

---

## 聯絡資訊

如有問題或建議，請聯絡開發團隊。

---

**最後更新：2025-11-26**
**版本：V3.1.0**
**功能：AI 需求優化**
